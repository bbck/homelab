#cloud-config

hostname: $HOST
timezone: "America/Los_Angeles"

chpasswd:
  expire: false
  list:
    - ubuntu:ubuntu

users:
  - name: ubuntu
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    lock_passwd: true
    ssh_import_id:
      - gh:bbck

apt:
  sources:
    tailscale.list:
      source: deb [signed-by=$KEY_FILE] https://pkgs.tailscale.com/stable/ubuntu $RELEASE main
      keyid: 2596A99EAAB33821893C0A79458CA832957F5868

package_update: true
package_upgrade: true
package_reboot_if_required: true

packages:
  - linux-modules-extra-raspi # Required for veth
  - tailscale

bootcmd:
  - [sleep, "60"] # wait for clock sync

runcmd:
  - [tailscale, up, --authkey, "file:/boot/firmware/tailscale-authkey"]
  - [rm, /boot/firmware/tailscale-authkey]

# For debugging
#output: { all: "| tee -a /boot/firmware/cloud-init-output.log" }
